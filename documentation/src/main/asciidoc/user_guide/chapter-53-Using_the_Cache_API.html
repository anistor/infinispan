<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>The Cache APIs</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_the_cache_apis">The Cache APIs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_cache_interface">The Cache interface</h3>
<div class="paragraph">
<p>Infinispan exposes a simple, <a href="http://jcp.org/en/jsr/detail?id=107">JSR-107</a> compliant <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html">Cache</a> interface.</p>
</div>
<div class="paragraph">
<p>The Cache interface exposes simple methods for adding, retrieving and removing entries, including atomic mechanisms exposed by the JDK&#8217;s ConcurrentMap interface.  Based on the cache mode used, invoking these methods will trigger a number of things to happen, potentially even including replicating an entry to a remote node or looking up an entry from a remote node, or potentially a cache store.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
For simple usage, using the Cache API should be no different from using the JDK Map API, and hence migrating from simple in-memory caches based on a Map to Infinispan&#8217;s Cache should be trivial.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_performance_concerns_of_certain_map_methods">Performance Concerns of Certain Map Methods</h4>
<div class="paragraph">
<p>Certain methods exposed in Map have certain performance consequences when used with Infinispan, such as
<a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#size%28%29">size()</a> ,
<a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#values%28%29">values()</a> ,
<a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#keySet%28%29">keySet()</a> and
<a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#entrySet%28%29">entrySet()</a> .
Specific methods on the <code>keySet</code>, <code>values</code> and <code>entrySet</code> are fine for use please see their Javadoc for further details.</p>
</div>
<div class="paragraph">
<p>Attempting to perform these operations globally would have large performance impact as well as become a scalability bottleneck.  As such, these methods should only be used for informational or debugging purposes only.</p>
</div>
<div class="paragraph">
<p>It should be noted that using certain flags with the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/AdvancedCache.html#withFlags%28org.infinispan.context.Flag&#8230;&#8203;%29">withFlags</a> method can mitigate some of these concerns, please check each method&#8217;s documentation for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mortal_and_immortal_data">Mortal and Immortal Data</h4>
<div class="paragraph">
<p>Further to simply storing entries, Infinispan&#8217;s cache API allows you to attach mortality information to data.  For example, simply using <a href="http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#put%28K,%20V%29">put(key, value)</a> would create an <em>immortal</em> entry, i.e., an entry that lives in the cache forever, until it is removed (or evicted from memory to prevent running out of memory).  If, however, you put data in the cache using <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#put%28K,%20V,%20long,%20java.util.concurrent.TimeUnit%29">put(key, value, lifespan, timeunit)</a> , this creates a <em>mortal</em> entry, i.e., an entry that has a fixed lifespan and expires after that lifespan.</p>
</div>
<div class="paragraph">
<p>In addition to <em>lifespan</em> , Infinispan also supports <em>maxIdle</em> as an additional metric with which to determine expiration.  Any combination of lifespans or maxIdles can be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_of_using_expiry_and_mortal_data">Example of Using Expiry and Mortal Data</h4>
<div class="paragraph">
<p>See <a href="#_eviction_examples">these examples</a> of using mortal data with Infinispan.</p>
</div>
</div>
<div class="sect3">
<h4 id="_putforexternalread_operation">putForExternalRead operation</h4>
<div class="paragraph">
<p>Infinispan&#8217;s <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html">Cache</a> class contains a different 'put' operation called link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead] . This operation is particularly useful when Infinispan is used as a temporary cache for data that is persisted elsewhere.  Under heavy read scenarios, contention in the cache should not delay the real transactions at hand, since caching should just be an optimization and not something that gets in the way.</p>
</div>
<div class="paragraph">
<p>To achieve this, putForExternalRead acts as a put call that only operates if the key is not present in the cache, and fails fast and silently if another thread is trying to store the same key at the same time. In this particular scenario, caching data is a way to optimise the system and it&#8217;s not desirable that a failure in caching affects the on-going transaction, hence why failure is handled differently. putForExternalRead is consider to be a fast operation because regardless of whether it&#8217;s successful or not, it doesn&#8217;t wait for any locks, and so returns to the caller promptly.</p>
</div>
<div class="paragraph">
<p>To understand how to use this operation, let&#8217;s look at basic example. Imagine a cache of Person instances, each keyed by a PersonId , whose data originates in a separate data store. The following code shows the most common pattern of using link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead] within the context of this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Id of the person to look up, provided by the application
PersonId id = ...;

// Get a reference to the cache where person instances will be stored
Cache&lt;PersonId, Person&gt; cache = ...;

// First, check whether the cache contains the person instance
// associated with with the given id
Person cachedPerson = cache.get(id);

if (cachedPerson == null) {
   // The person is not cached yet, so query the data store with the id
   Person person = dataStore.lookup(id);

   // Cache the person along with the id so that future requests can
   // retrieve it from memory rather than going to the data store
   cache.putForExternalRead(id, person);
} else {
   // The person was found in the cache, so return it to the application
   return cachedPerson;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead] should never be used as a mechanism to update the cache with a new Person instance originating from application execution (i.e. from a transaction that modifies a Person&#8217;s address). When updating cached values, please use the standard link:http://docs.oracle.com/javase/6/docs/api/java/util/Map.html#put(K, V)[put] operation, otherwise the possibility of caching corrupt data is likely.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_advancedcache_interface">The AdvancedCache interface</h3>
<div class="paragraph">
<p>In addition to the simple Cache interface, Infinispan offers an <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/AdvancedCache.html">AdvancedCache</a> interface, geared towards extension authors.  The AdvancedCache offers the ability to inject custom interceptors, access certain internal components and to apply flags to alter the default behavior of certain cache methods.  The following code snippet depicts how an AdvancedCache can be obtained:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">AdvancedCache advancedCache = cache.getAdvancedCache();</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_flags">Flags</h4>
<div class="paragraph">
<p>Flags are applied to regular cache methods to alter the behavior of certain methods.  For a list of all available flags, and their effects, see the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/context/Flag.html">Flag</a> enumeration.  Flags are applied using <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/AdvancedCache.html#withFlags%28org.infinispan.context.Flag&#8230;&#8203;%29">AdvancedCache.withFlags()</a> .  This builder method can be used to apply any number of flags to a cache invocation, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">advancedCache.withFlags(Flag.CACHE_MODE_LOCAL, Flag.SKIP_LOCKING)
   .withFlags(Flag.FORCE_SYNCHRONOUS)
   .put("hello", "world");</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entry_retrieval">Entry Retrieval</h4>
<div class="paragraph">
<p>It is possible to retrieve all of the entries stored in a given cache, irrespective of its clustering configuration.
These entries are only retrieved through an iterator where each value is only returned one at a time.
This is done because of the possible memory constraints of pulling all the values into a single node at the same time.</p>
</div>
<div class="paragraph">
<p>An <code>EntryIterable</code> is available by invoking the
<a href="https://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/AdvancedCache.html#filterEntries(org.infinispan.filter.KeyValueFilter)">filterEntries</a>
method on <code>AdvancedCache</code>.  Note you are required to provide a <code>KeyValueFilter</code>, this is to make sure users realize this can be an expensive operation and by filtering entries on the remote side will allow the operation to perform faster and more efficiently.
This allows you to iterate over the contents in the cache in a memory sensitive way so out of memory errors should not occur.
The size of contents held in memory by the iterator while being processed currently is limited by the state transfer chunk size configuration value.</p>
</div>
<div class="paragraph">
<p>Once the <code>EntryIterable</code> is retrieved, invocation of the iterator method will immediately start retrieving entries.  Note each invocation of the iterator method will start a brand new entry request thus allowing the <code>Iterable</code> to be reused.</p>
</div>
<div class="paragraph">
<p><code>EntryIterable</code> also implements <code>AutoCloseable</code> so it should be done in a try with resource block to ensure that all resources can be closed properly after invocation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">KeyValueFilter&lt;Object, Object&gt; filter = ...
try (EntryIterable&lt;Object, Object&gt; iterable = advancedCache.filterEntries(filter)) {
  for (CacheEntry&lt;Object, Object&gt; entry : iterable) {
     // Do something
  }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_transactional_aware">Transactional Aware</h5>
<div class="paragraph">
<p>The iterators produced will obey the current transaction if there is one when they are generated.  Note the transaction they use is the one that is found to be in the thread when <code>filterEntries</code> is first invoked.  Thus you should only access this iterator from the same thread or else undefind behavior may occur.</p>
</div>
<div class="paragraph">
<p>Since we cannot put all entries into the local transaction any entries retrieved using the iterator are not added to the transaction context.  This means that the iterator will behave always in a way similar to a Read Committed isolation level even if Repeatable Read is enabled for example.  If an entry was previously put in the context it will use this value, including if it was removed, in which case it will not be returned from the iterator.</p>
</div>
</div>
<div class="sect4">
<h5 id="_iterator_remove">Iterator remove</h5>
<div class="paragraph">
<p>We also do support the remove operation on the iterator.  In a non transactional cache this will immediately remove the key from the cache.  In a transactional cache this will instead be added to the existing transaction context if there is one otherwise an implicit transaction will be generated for it.</p>
</div>
</div>
<div class="sect4">
<h5 id="_value_conversion">Value conversion</h5>
<div class="paragraph">
<p>While the provided filter can be used to efficiently reduce what entries are returned to the local node, there is also the possibility of providing an optional <a href="https://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/filter/Converter.html">Converter</a> which will convert the provided value to another object or even type, which is done on the remote side.  This is useful to reduce payload size when you may want only a partial view of the object or even an object that is created from it.</p>
</div>
<div class="paragraph">
<p>In this case we have a converter that can be used to convert a Car instance to instead return one of its wheels as determined by the value passed to the converter when created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class CarWheelConverter implements Converter&lt;String, Car, Wheel&gt; {
   private final int wheelPosition;

   public CarWheelConverter(int wheelPosition) {
     this.wheelPosition = wheelPosition;
   }
   @Override
   public Wheel convert(String key, Car value, Metadata metadata) {
      return value.getWheels().wheel(wheelPosition);
   }
}


try (CloseableIterable&lt;CacheEntry&lt;String, Wheel&gt;&gt; iterable = advancedCache.filterEntries(teslaCarFilter).converter(new CarWheelConverter(3)) {
   for (CacheEntry&lt;String, Wheel&gt; entry : iterable) {
      // Do something with the third wheel of the car
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Remember that both the <code>KeyValueFilter</code> and the <code>Converter</code> must either implement <code>Serializable</code> or have a provided Infinispan <code>Externalizer</code>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_custom_interceptors">Custom Interceptors</h4>
<div class="paragraph">
<p>The AdvancedCache interface also offers advanced developers a mechanism with which to attach custom interceptors.  Custom interceptors allow developers to alter the behavior of the cache API methods, and the AdvancedCache interface allows developers to attach these interceptors programmatically, at run-time.  See the AdvancedCache Javadocs for more details.</p>
</div>
<div class="paragraph">
<p>For more information on writing custom interceptors, see <a href="#_custom_interceptors_chapter">this chapter</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_Listeners_and_notifications_section">Listeners and Notifications</h3>
<div class="paragraph">
<p>Infinispan offers a listener API, where clients can register for and get notified when events take place.  This annotation-driven API applies to 2 different levels: cache level events and cache manager level events.</p>
</div>
<div class="paragraph">
<p>Events trigger a notification which is dispatched to listeners.   Listeners are simple <a href="http://en.wikipedia.org/wiki/Plain_Old_Java_Object">POJO</a> s annotated with <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/Listener.html">@Listener</a> and registered using the methods defined in the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/Listenable.html">Listenable</a> interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Both Cache and CacheManager implement Listenable, which means you can attach listeners to either a cache or a cache manager, to receive either cache-level or cache manager-level notifications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, the following class defines a listener to print out some information every time a new entry is added to the cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener
public class PrintWhenAdded {

  @CacheEntryCreated
  public void print(CacheEntryCreatedEvent event) {
    System.out.println("New entry " + event.getKey() + " created in the cache");
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more comprehensive examples, please see the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/Listener.html">Javadocs for @Listener</a>.</p>
</div>
<div class="sect3">
<h4 id="_cache_level_notifications">Cache-level notifications</h4>
<div class="paragraph">
<p>Cache-level events occur on a per-cache basis, and by default are only raised on nodes where the events occur.  Note in a distributed cache these events are only raised on the owners of data being affected.  Examples of cache-level events are entries being added, removed, modified, etc.  These events trigger notifications to listeners registered to a specific cache.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for a comprehensive list of all cache-level notifications, and their respective method-level annotations.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Please refer to the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/cachelistener/annotation/package-summary.html">Javadocs on the org.infinispan.notifications.cachelistener.annotation package</a> for the list of cache-level notifications available in Infinispan.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_cluster_listeners">Cluster Listeners</h5>
<div class="paragraph">
<p>The cluster listeners should be used when it is desirable to listen to the cache events on a single node.</p>
</div>
<div class="paragraph">
<p>To do so all that is required is set to annotate your listener as being clustered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener (clustered = true)
public class MyClusterListener { .... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some limitations to cluster listeners from a non clustered listener.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A cluster listener can only listen to <code>@CacheEntryModified</code>, <code>@CacheEntryCreated</code> and <code>@CacheEntryRemoved</code> events.  Note this means any other type of event will not be listened to for this listener.</p>
</li>
<li>
<p>Only the post event is sent to a cluster listener, the pre event is ignored.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_event_filtering_and_conversion">Event filtering and conversion</h5>
<div class="paragraph">
<p>All applicable events on the node where the listener is installed will be raised to the listener.  It is possible to dynamically filter what events are raised by using a <a href="https://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/filter/KeyFilter.html">KeyFilter</a> (only allows filtering on keys) or <a href="https://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventFilter.html">CacheEventFilter</a> (used to filter for keys, old value, old metadata, new value, new metadata, whether command was retried, if the event is before the event (ie. isPre) and also the command type).</p>
</div>
<div class="paragraph">
<p>The example here shows a simple <code>KeyFilter</code> that will only allow events to be raised when an event modified the entry for the key <code>Only Me</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class SpecificKeyFilter implements KeyFilter&lt;String&gt; {
    private final String keyToAccept;

    public SpecificKeyFilter(String keyToAccept) {
      if (keyToAccept == null) {
        throw new NullPointerException();
      }
      this.keyToAccept = keyToAccept;
    }

    boolean accept(String key) {
      return keyToAccept.equals(key);
    }
}

...
cache.addListener(listener, new SpecificKeyFilter("Only Me"));
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful when you want to limit what events you receive in a more efficient manner.</p>
</div>
<div class="paragraph">
<p>There is also a <a href="https://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/cachelistener/filter/CacheEventConverter.html">CacheEventConverter</a> that can be supplied that allows for converting a value to another before raising the event.  This can be nice to modularize any code that does value conversions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The mentioned filters and converters are especially beneficial when used in conjunction with a Cluster Listener.  This is because the filtering and conversion is done on the node where the event originated and not on the node where event is listened to.  This can provide benefits of not having to replicate events across the cluster (filter) or even have reduced payloads (converter).
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_initial_state_events">Initial State Events</h5>
<div class="paragraph">
<p>When a listener is installed it will only be notified of events after it is fully installed.</p>
</div>
<div class="paragraph">
<p>It may be desirable to get the current state of the cache contents upon first registration of listener by having an event generated of type <code>@CacheEntryCreated</code> for each element in the cache.  Any additionally generated events during this initial phase will be queued until appropriate events have been raised.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This only works for clustered listeners at this time.  <a href="https://issues.jboss.org/browse/ISPN-4608">ISPN-4608</a> covers adding this for non clustered listeners.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_duplicate_events">Duplicate Events</h5>
<div class="paragraph">
<p>It is possible in a non transactional cache to receive duplicate events.  This is possible when the primary owner of a key goes down while trying to perform a write operation such as a put.</p>
</div>
<div class="paragraph">
<p>Infinispan internally will rectify the put operation by sending it to the new primary owner for the given key automatically, however there are no guarantees in regards to if the write was first replicated to backups.  Thus more than 1 of the following write events (<code>CacheEntryCreatedEvent</code>, <code>CacheEntryModifiedEvent</code> &amp; <code>CacheEntryRemovedEvent</code>) may be sent on a single operation.</p>
</div>
<div class="paragraph">
<p>If more than one event is generated Infinispan will mark the event that it was generated by a retried command to help the user to know when this occurs without having to pay attention to view changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener
public class MyRetryListener {
  @CacheEntryModified
  public void entryModified(CacheEntryModifiedEvent event) {
    if (event.isCommandRetried()) {
      // Do something
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also when using a <code>CacheEventFilter</code> or <code>CacheEventConverter</code> the <a href="https://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/cachelistener/filter/EventType.html">EventType</a> contains a method <code>isRetry</code> to tell if the event was generated due to retry.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cache_manager_level_notifications">Cache manager-level notifications</h4>
<div class="paragraph">
<p>Cache manager-level events occur on a cache manager.  These too are global and  cluster-wide, but involve events that affect all caches created by a single cache manager.  Examples of cache manager-level events are nodes joining or leaving a cluster, or caches starting or stopping.</p>
</div>
<div class="paragraph">
<p>Please see the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/notifications/cachemanagerlistener/annotation/package-summary.html">Javadocs  on the org.infinispan.notifications.cachemanagerlistener.annotation package</a> for a comprehensive list of all cache manager-level notifications,  and their respective method-level annotations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_synchronicity_of_events">Synchronicity of events</h4>
<div class="paragraph">
<p>By default, all notifications are dispatched in the same thread that generates the event.  This means that you <em>must</em> write your listener such that it does not block or do anything that takes too long, as it would prevent the thread from progressing.  Alternatively, you could annotate your listener as <em>asynchronous</em> , in which case a separate thread pool will be used to dispatch the notification and prevent blocking the event originating thread.  To do this, simply annotate your listener such:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Listener (sync = false)
public class MyAsyncListener { .... }</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_asynchronous_thread_pool">Asynchronous thread pool</h5>
<div class="paragraph">
<p>To tune the thread pool used to dispatch such asynchronous notifications, use the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/configdocs/infinispan-config-{infinispanversion}.html"><code>&lt;listener-executor /&gt;</code></a> XML element in your configuration file.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_asynchronous_api">Asynchronous API</h3>
<div class="paragraph">
<p>In addition to synchronous API methods like <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html#put%28K,%20V%29">Cache.put()</a> , <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Map.html#remove%28java.lang.Object%29">Cache.remove()</a> , etc., Infinispan also has an asynchronous, non-blocking API where you can achieve the same results in a non-blocking fashion.</p>
</div>
<div class="paragraph">
<p>These methods are named in a similar fashion to their blocking counterparts, with "Async" appended.  E.g., <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#putAsync%28K,%20V%29">Cache.putAsync()</a> , <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#removeAsync%28java.lang.Object%29">Cache.removeAsync()</a> , etc.  These asynchronous counterparts return a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Future.html">Future</a> containing the actual result of the operation.</p>
</div>
<div class="paragraph">
<p>For example, in a cache parameterized as <code>Cache&lt;String, String&gt;</code>, <code>Cache.put(String key, String value)</code> returns a <code>String</code>.
<code>Cache.putAsync(String key, String value)</code> would return a <code>Future&lt;String&gt;</code>.</p>
</div>
<div class="sect3">
<h4 id="_why_use_such_an_api">Why use such an API?</h4>
<div class="paragraph">
<p>Non-blocking APIs are powerful in that they provide all of the guarantees of synchronous communications - with the ability to handle communication failures and exceptions - with the ease of not having to block until a call completes.  This allows you to better harness parallelism in your system.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Set&lt;Future&lt;?&gt;&gt; futures = new HashSet&lt;Future&lt;?&gt;&gt;();
futures.add(cache.putAsync(key1, value1)); // does not block
futures.add(cache.putAsync(key2, value2)); // does not block
futures.add(cache.putAsync(key3, value3)); // does not block

// the remote calls for the 3 puts will effectively be executed
// in parallel, particularly useful if running in distributed mode
// and the 3 keys would typically be pushed to 3 different nodes
// in the cluster

// check that the puts completed successfully
for (Future&lt;?&gt; f: futures) f.get();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_which_processes_actually_happen_asynchronously">Which processes actually happen asynchronously?</h4>
<div class="paragraph">
<p>There are 4 things in Infinispan that can be considered to be on the critical path of a typical write operation.
These are, in order of cost:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>network calls</p>
</li>
<li>
<p>marshalling</p>
</li>
<li>
<p>writing to a cache store (optional)</p>
</li>
<li>
<p>locking</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As of Infinispan 4.0, using the async methods will take the network calls and marshalling off the critical path.  For various technical reasons, writing to a cache store and acquiring locks, however, still happens in the caller&#8217;s thread.  In future, we plan to take these offline as well.  See <a href="http://lists.jboss.org/pipermail/infinispan-dev/2010-January/002219.html">this developer mail list thread</a> about this topic.</p>
</div>
</div>
<div class="sect3">
<h4 id="_notifying_futures">Notifying futures</h4>
<div class="paragraph">
<p>Strictly, these methods do not return JDK Futures, but rather a sub-interface known as a <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/commons/util/concurrent/NotifyingFuture.html">NotifyingFuture</a> .  The main difference is that you can attach a listener to a NotifyingFuture such that you could be notified when the future completes.  Here is an example of making use of a notifying future:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">FutureListener futureListener = new FutureListener() {

   public void futureDone(Future future) {
      try {
         future.get();
      } catch (Exception e) {
         // Future did not complete successfully
         System.out.println("Help!");
      }
   }
};
     
cache.putAsync("key", "value").attachListener(futureListener);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_further_reading">Further reading</h4>
<div class="paragraph">
<p>The Javadocs on the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html">Cache</a> interface has some examples on using the asynchronous API, as does <a href="http://infinispan.blogspot.com/2009/05/whats-so-cool-about-asynchronous-api.html">this article</a> by Manik Surtani introducing the API.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_invocation_flags">Invocation Flags</h3>
<div class="paragraph">
<p>An important aspect of getting the most of Infinispan is the use of per-invocation flags in order to provide specific behaviour to each particular cache call. By doing this, some important optimizations can be implemented potentially saving precious time and network resources. One of the most popular usages of flags can be found right in Cache API, underneath the link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/Cache.html#putForExternalRead(K, V)[putForExternalRead()] method which is used to load an Infinispan cache with data read from an external resource. In order to make this call efficient, Infinispan basically calls a normal put operation passing the following flags: <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/context/Flag.html#FAIL_SILENTLY">FAIL_SILENTLY</a> , <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/context/Flag.html#FORCE_ASYNCHRONOUS">FORCE_ASYNCHRONOUS</a> , <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/context/Flag.html#ZERO_LOCK_ACQUISITION_TIMEOUT">ZERO_LOCK_ACQUISITION_TIMEOUT</a></p>
</div>
<div class="paragraph">
<p>What Infinispan is doing here is effectively saying that when putting data read from external read, it will use an almost-zero lock acquisition time and that if the locks cannot be acquired, it will fail silently without throwing any exception related to lock acquisition. It also specifies that regardless of the cache mode, if the cache is clustered, it will replicate asynchronously and so won&#8217;t wait for responses from other nodes. The combination of all these flags make this kind of operation very efficient, and the efficiency comes from the fact this type of <em>putForExternalRead</em> calls are used with the knowledge that client can always head back to a persistent store of some sorts to retrieve the data that should be stored in memory. So, any attempt to store the data is just a best effort and if not possible, the client should try again if there&#8217;s a cache miss.</p>
</div>
<div class="sect3">
<h4 id="_decoratedcache">DecoratedCache</h4>
<div class="paragraph">
<p>Another approach would be to use the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/DecoratedCache.html">DecoratedCache</a> wrapper.
This allows you to reuse flags. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">AdvancedCache cache = ...
DecoratedCache strictlyLocal = new DecoratedCache(cache, Flag.CACHE_MODE_LOCAL, Flag.SKIP_CACHE_STORE);
strictlyLocal.put("local_1", "only");
strictlyLocal.put("local_2", "only");
strictlyLocal.put("local_3", "only");</code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach makes your code more readable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_examples">Examples</h4>
<div class="paragraph">
<p>If you want to use these or any other flags available, which by the way are described in detail the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> , you simply need to get hold of the advanced cache and add the flags you need via the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag&#8230;&#8203;)">withFlags()</a> method call. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Cache cache = ...
cache.getAdvancedCache()
   .withFlags(Flag.SKIP_CACHE_STORE, Flag.CACHE_MODE_LOCAL)
   .put("local", "only");</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s worth noting that these flags are only active for the duration of the cache operation. If the same flags need to be used in several invocations, even if they&#8217;re in the same transaction, <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/AdvancedCache.html#withFlags(org.infinispan.context.Flag&#8230;&#8203;)">withFlags()</a> needs to be called repeatedly. Clearly, if the cache operation is to be replicated in another node, the flags are carried over to the remote nodes as well.</p>
</div>
<div class="sect4">
<h5 id="_suppressing_return_values_from_a_put_or_remove">Suppressing return values from a put() or remove()</h5>
<div class="paragraph">
<p>Another very important use case is when you want a write operation such as put() to <em>not</em> return the previous value. To do that, you need to use two flags to make sure that in a distributed environment, no remote lookup is done to potentially get previous value, and if the cache is configured with a cache loader, to avoid loading the previous value from the cache store. You can see these two flags in action in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Cache cache = ...
cache.getAdvancedCache()
   .withFlags(Flag.SKIP_REMOTE_LOOKUP, Flag.SKIP_CACHE_LOAD)
   .put("local", "only")</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, please check the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/context/Flag.html">Flag enumeration</a> javadoc.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tree_api_module">Tree API Module</h3>
<div class="paragraph">
<p><a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/package-summary.html">Infinispan&#8217;s tree API module</a> offers clients the possibility of storing data using a tree-structure like API. This API is similar to the one <a href="http://docs.jboss.org/jbosscache/3.2.1.GA/apidocs/org/jboss/cache/package-summary.html">provided by JBoss Cache</a>, hence the tree module is perfect for those users wanting to migrate their applications from JBoss Cache to Infinispan, who want to limit changes their codebase as part of the migration. Besides, it&#8217;s important to understand that Infinispan provides this tree API much more efficiently than JBoss Cache did, so if you&#8217;re a user of the tree API in JBoss Cache, you should consider migrating to Infinispan.</p>
</div>
<div class="sect3">
<h4 id="_what_is_tree_api_about">What is Tree API about?</h4>
<div class="paragraph">
<p>The aim of this API is to store information in a hierarchical way. The hierarchy is defined using paths represented as <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/Fqn.html">Fqn or fully qualified names</a> , for example: <em>/this/is/a/fqn/path</em> or <em>/another/path</em> . In the hierarchy, there&#8217;s a special path called root which represents the starting point of all paths and it&#8217;s represented as: <em>/</em></p>
</div>
<div class="paragraph">
<p>Each FQN path is represented as a node where users can store data using a key/value pair style API (i.e. a Map). For example, in <em>/persons/john</em> , you could store information belonging to John, for example: surname=Smith, birthdate=05/02/1980&#8230;&#8203;etc.</p>
</div>
<div class="paragraph">
<p>Please remember that users should not use root as a place to store data. Instead, users should define their own paths and store data there. The following sections will delve into the practical aspects of this API.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_tree_api">Using the Tree API</h4>
<div class="sect4">
<h5 id="_dependencies">Dependencies</h5>
<div class="paragraph">
<p>For your application to use the tree API, you need to import infinispan-tree.jar which can be located in the Infinispan binary distributions, or you can simply add a dependency to this module in your pom.xml:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;
  ...
  &lt;dependency&gt;
    &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
    &lt;artifactId&gt;infinispan-tree&lt;/artifactId&gt;
    &lt;version&gt;$put-infinispan-version-here&lt;/version&gt;
  &lt;/dependency&gt;
  ...
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_tree_cache">Creating a Tree Cache</h4>
<div class="paragraph">
<p>The first step to use the tree API is to actually create a tree cache. To do so, you need to <a href="#_configuring_cache">create an Infinispan Cache as you&#8217;d normally do, and using the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/TreeCacheFactory.html">TreeCacheFactory</a> , create an instance of <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> . A very important note to remember here is that the Cache instance passed to the factory must be configured with &lt;&lt;_batching, invocation batching</a>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.config.Configuration;
import org.infinispan.tree.TreeCacheFactory;
import org.infinispan.tree.TreeCache;
...
Configuration config = new Configuration();
config.setInvocationBatchingEnabled(true);
Cache cache = new DefaultCacheManager(config).getCache();
TreeCache treeCache = TreeCacheFactory.createTreeCache(cache);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manipulating_data_in_a_tree_cache">Manipulating data in a Tree Cache</h4>
<div class="paragraph">
<p>The Tree API effectively provides two ways to interact with the data:</p>
</div>
<div class="paragraph">
<p>Via <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/TreeCache.html">TreeCache</a> convenience methods: These methods are located within the TreeCache interface and enable users to link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/TreeCache.html#put(java.lang.String, K, V)[store] , link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/TreeCache.html#get(org.infinispan.tree.Fqn, K)[retrieve] , link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/TreeCache.html#move(org.infinispan.tree.Fqn, org.infinispan.tree.Fqn)[move] , link:http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/TreeCache.html#remove(org.infinispan.tree.Fqn, K)[remove] &#8230;&#8203;etc data with a single call that takes the <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/Fqn.html">Fqn</a> , in String or Fqn format, and the data involved in the call. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">treeCache.put("/persons/john", "surname", "Smith");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.tree.Fqn;
...
Fqn johnFqn = Fqn.fromString("persons/john");
Calendar calendar = Calendar.getInstance();
calendar.set(1980, 5, 2);
treeCache.put(johnFqn, "birthdate", calendar.getTime()));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Via <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/Node.html">Node</a> API: It allows finer control over the individual nodes that form the FQN, allowing manipulation of nodes relative to a particular node. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.tree.Node;
...
TreeCache treeCache = ...
Fqn johnFqn = Fqn.fromElements("persons", "john");
Node&lt;String, Object&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put("surname", "Smith");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Node persons = treeCache.getRoot().addChild(Fqn.fromString("persons"));
Node&lt;String, Object&gt; john = persons.addChild(Fqn.fromString("john"));
john.put("surname", "Smith");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or even:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Fqn personsFqn = Fqn.fromString("persons");
Fqn johnFqn = Fqn.fromRelative(personsFqn, Fqn.fromString("john"));
Node&lt;String, Object&gt; john = treeCache.getRoot().addChild(johnFqn);
john.put("surname", "Smith");</code></pre>
</div>
</div>
<div class="paragraph">
<p>A node also provides the ability to access its <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/Node.html#getParent()">parent</a> or <a href="http://docs.jboss.org/infinispan/{infinispanversion}/apidocs/org/infinispan/tree/Node.html#getChildren()">children</a> . For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Node&lt;String, Object&gt; john = ...
Node persons = john.getParent();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Set&lt;Node&lt;String, Object&gt;&gt; personsChildren = persons.getChildren();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_common_operations">Common Operations</h4>
<div class="paragraph">
<p>In the previous section, some of the most used operations, such as addition and retrieval, have been shown. However, there are other important operations that are worth mentioning, such as remove:</p>
</div>
<div class="paragraph">
<p>You can for example remove an entire node, i.e. <em>/persons/john</em> , using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">treeCache.removeNode("/persons/john");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or remove a child node, i.e. persons that a child of root, via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">treeCache.getRoot().removeChild(Fqn.fromString("persons"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also remove a particular key/value pair in a node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Node john = treeCache.getRoot().getChild(Fqn.fromElements("persons", "john"));
john.remove("surname");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can remove all data in a node with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Node john = treeCache.getRoot().getChild(Fqn.fromElements("persons", "john"));
john.clearData();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another important operation supported by Tree API is the ability to move nodes around in the tree. Imagine we have a node called "john" which is located under root node. The following example is going to show how to we can move "john" node to be under "persons" node:</p>
</div>
<div class="paragraph">
<p>Current tree structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   /persons
   /john</pre>
</div>
</div>
<div class="paragraph">
<p>Moving trees from one FQN to another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Node john = treeCache.getRoot().addChild(Fqn.fromString("john"));
Node persons = treeCache.getRoot().getChild(Fqn.fromString("persons"));
treeCache.move(john.getFqn(), persons.getFqn());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Final tree structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>   /persons/john</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_locking_in_the_tree_api">Locking in the Tree API</h4>
<div class="paragraph">
<p>Understanding when and how locks are acquired when manipulating the tree structure is important in order to maximise the performance of any client application interacting against the tree, while at the same time maintaining consistency.</p>
</div>
<div class="paragraph">
<p>Locking on the tree API happens on a per node basis. So, if you&#8217;re putting or updating a key/value under a particular node, a write lock is acquired for that node. In such case, no write locks are acquired for parent node of the node being modified, and no locks are acquired for children nodes.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re adding or removing a node, the parent is not locked for writing. In JBoss Cache, this behaviour was configurable with the default being that parent was not locked for insertion or removal.</p>
</div>
<div class="paragraph">
<p>Finally, when a node is moved, the node that&#8217;s been moved and any of its children are locked, but also the target node and the new location of the moved node and its children. To understand this better, let&#8217;s look at an example:</p>
</div>
<div class="paragraph">
<p>Imagine you have a hierarchy like this and we want to move c/ to be underneath b/:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>        /
      --|--
     /     \
     a     c
     |     |
     b     e
     |
     d</pre>
</div>
</div>
<div class="paragraph">
<p>The end result would be something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>        /
        |         
        a    
        |    
        b    
      --|--
     /     \
     d     c
           |
           e</pre>
</div>
</div>
<div class="paragraph">
<p>To make this move, locks would have been acquired on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>/a/b</em> - because it&#8217;s the parent underneath which the data will be put</p>
</li>
<li>
<p><em>/c</em> and <em>/c/e</em> - because they&#8217;re the nodes that are being moved</p>
</li>
<li>
<p><em>/a/b/c</em> and <em>/a/b/c/e</em> - because that&#8217;s new target location for the nodes being moved</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sid-68355037_TreeAPIModule-Listenersfortreecacheevents">Listeners for tree cache events</h4>
<div class="paragraph">
<p>The current Infinispan listeners have been designed with key/value store notifications in mind, and hence they do not map to tree cache events correctly. Tree cache specific listeners that map directly to tree cache events (i.e. adding a child&#8230;&#8203;etc) are desirable but these are not yet available. If you&#8217;re interested in this type of listeners, please follow <a href="https://issues.jboss.org/browse/ISPN-1935">this issue</a> to find out about any progress in this area.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functional_map_api">Functional Map API</h3>
<div class="paragraph">
<p>Infinispan 8 introduces a new experimental API for interacting with your
 data which takes advantage of the functional programming additions and
 improved asynchronous programming capabilities available in Java 8.</p>
</div>
<div class="paragraph">
<p>Infinispan&#8217;s Functional Map API is a distilled map­like asynchronous API
 which uses lambdas to interact with data.</p>
</div>
<div class="sect3">
<h4 id="_asynchronous_and_lazy">Asynchronous and Lazy</h4>
<div class="paragraph">
<p>Being an asynchronous API, all methods that return a single result,
 return a CompletableFuture which wraps the result, so you can use the
 resources of your system more efficiently by having the possibility to
 receive callbacks when the CompletableFuture has completed, or you can
 chain or compose them with other CompletableFuture.</p>
</div>
<div class="paragraph">
<p>For those operations that return multiple results, the API returns
 instances of a ​Traversable interface which offers a lazy pull­style
 API for working with multiple results. T​raversable,​ being a lazy
 pull­style API, can still be asynchronous underneath since the user can
 decide to work on the traversable at a later stage, and the Traversable
 implementation itself can decide when to compute those results.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lambda_transparency">Lambda transparency</h4>
<div class="paragraph">
<p>Since the content of the lambdas is transparent to Infinispan, the API
 has been split into 3 interfaces for read­-only (R​eadOnlyMap)​, read­-write
 (R​eadWriteMap)​ and write­-only (W​riteOnlyMap)​ operations respectively,
 in order to provide hints to the Infinispan internals on the type of
 work needed to support lambdas.</p>
</div>
</div>
<div class="sect3">
<h4 id="_constructing_functional_maps">Constructing Functional Maps</h4>
<div class="paragraph">
<p>To construct any of the read-only, write-only or read-write map
 instances, an Infinispan AdvancedCache is required, which is retrieved
 from the Cache Manager, and using the AdvancedCache, static method
 factory methods are used to create R​eadOnlyMap, R​eadWriteMap or
 W​riteOnlyMap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.commons.api.functional.FunctionalMap.*;
import org.infinispan.functional.impl.*;

AdvancedCache&lt;String, String&gt; cache = ...

FunctionalMapImpl&lt;String, String&gt; functionalMap = FunctionalMapImpl.create(cache);
ReadOnlyMap&lt;String, String&gt; readOnlyMap = ReadOnlyMapImpl.create(functionalMap);
WriteOnlyMap&lt;String, String&gt; writeOnlyMap = WriteOnlyMapImpl.create(functionalMap);
ReadWriteMap&lt;String, String&gt; readWriteMap = ReadWriteMapImpl.create(functionalMap);</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
At this stage, the Functional Map API is experimental and hence the
 way FunctionalMap, ReadOnlyMap, WriteOnlyMap and ReadWriteMap are constructed
 is temporary.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_read_only_map_api">Read-Only Map API</h4>
<div class="paragraph">
<p>Read-only operations have the advantage that no locks are acquired
 for the duration of the operation. Here&#8217;s an example on how to the
 equivalent operation for Map.get(K):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.commons.api.functional.EntryView.*;
import org.infinispan.commons.api.functional.FunctionalMap.*;

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...
CompletableFuture&lt;Optional&lt;String&gt;&gt; readFuture = readOnlyMap.eval("key1", ReadEntryView::find);
readFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read-only map also exposes operations to retrieve multiple keys in one go:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.commons.api.functional.EntryView.*;
import org.infinispan.commons.api.functional.FunctionalMap.*;

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

Set&lt;String&gt; keys = new HashSet&lt;&gt;();
keys.add("key1");
keys.add("key2");

Traversable&lt;String&gt; values = readOnlyMap.evalMany(keys, ReadEntryView::get);
values.forEach(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, read-only map also exposes methods to read all existing keys as well
as entries, which include both key and value information.</p>
</div>
<div class="sect4">
<h5 id="_read_only_entry_view">Read-Only Entry View</h5>
<div class="paragraph">
<p>The lambda parameters for read-only maps provide the user with a read-only
 entry view to interact with the data in the cache, which include these
 operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>key()</code> method returns the key for which this lambda is being executed.</p>
</li>
<li>
<p><code>find()</code> returns an Java 8 <code>Optional</code> wrapping the value if present,
otherwise it returns an empty optional. Unless the value is guaranteed to
be associated with the key, it&#8217;s recommended to use <code>find()</code> to verify
whether there&#8217;s a value associated with the key.</p>
</li>
<li>
<p><code>get()</code> returns the value associated with the key. If the key has no value
associated with it, calling <code>get()</code> throws a <code>NoSuchElementException</code>.
<code>get()</code> can be considered as a shortcut of <code>ReadEntryView.find().get()</code>
which should be used only when the caller has guarantees that there&#8217;s
definitely a value associated with the key.</p>
</li>
<li>
<p><code>findMetaParam(Class&lt;T&gt; type)</code> allows metadata parameter information
associated with the cache entry to be looked up, for example: entry
lifespan, last  accessed time&#8230;&#8203;etc.
See <a href="#_meta_parameter">Metadata Parameter Handling section</a> to find out more.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_write_only_map_api">Write-Only Map API</h4>
<div class="paragraph">
<p>Write-only operations include operations that insert or update data in the
 cache and also removals. Crucially, a write-only operation does not attempt
 to read any previous value associated with the key. This is an important
 optimization since that means neither the cluster nor any persistence stores
 will be looked up to retrieve previous values. In the main Infinispan Cache,
 this kind of optimization was achieved using a local-only per-invocation
 flag, but the use case is so common that in this new functional API, this
 optimization is provided as a first-class citizen.</p>
</div>
<div class="paragraph">
<p>Using write-only map API, an operation equivalent to JCache&#8217;s void returning
 <code>put</code> can be achieved this way, followed by an attempt to read the stored
 value using the read-only map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.commons.api.functional.EntryView.*;
import org.infinispan.commons.api.functional.FunctionalMap.*;

WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...
ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;Void&gt; writeFuture = writeOnlyMap.eval("key1", "value1", (v, view) -&gt; view.set(v));
CompletableFuture&lt;String&gt; readFuture = writeFuture.thenCompose(r -&gt; readOnlyMap.eval("key1", ReadEntryView::get));
readFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple key/value pairs can be stored in one go using <code>evalMany</code> API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

Map&lt;K, String&gt; data = new HashMap&lt;&gt;();
data.put("key1", "value1");
data.put("key2", "value2");
CompletableFuture&lt;Void&gt; writerAllFuture = writeOnlyMap.evalMany(data, (v, view) -&gt; view.set(v));
writerAllFuture.thenAccept(x -&gt; "Write completed");</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove all contents of the cache, there are two possibilities with
 different semantics. If using <code>evalAll</code> each cached entry is iterated over
 and the lambda function is called with that entry&#8217;s information. Using
 this method also results in listeners
 (see <a href="#_functional_listeners">functional listeners section</a> for more information)
 being invoked:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

CompletableFuture&lt;Void&gt; removeAllFuture = writeOnlyMap.evalAll(WriteEntryView::remove);
removeAllFuture.thenAccept(x -&gt; "All entries removed");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The alternative way to remove all entries is to call <code>truncate</code> operation
 which clears the entire cache contents in one go without invoking any
 listeners and is best-effort:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...

CompletableFuture&lt;Void&gt; truncateFuture = writeOnlyMap.truncate();
truncateFuture.thenAccept(x -&gt; "Cache contents cleared");</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_write_only_entry_view">Write-Only Entry View</h5>
<div class="paragraph">
<p>The lambda parameters for write-only maps provide the user with a write-only
 entry view to modify the data in the cache, which include these
 operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>set(V, MetaParam.Writable&#8230;&#8203;)</code> method allows for a new value to be
associated with the cache entry for which this lambda is executed, and it
optionally takes zero or more metadata parameters to be stored along with
the value (see <a href="#_meta_parameter">Metadata Parameter Handling section</a> to
find out more).</p>
</li>
<li>
<p><code>remove()</code> method removes the cache entry, including both value and
metadata parameters associated with this key.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_read_write_map_api">Read-Write Map API</h4>
<div class="paragraph">
<p>The final type of operations we have are read­write operations, and within
 this category CAS-like (Compare­And­Swap) operations can be found.
 This type of operations require previous value associated with the key
 to be read and for locks to be acquired before executing the lambda.
 The vast majority of operations within ConcurrentMap and JCache APIs fall
 within this category, and they can easily be implemented using the
 read-write map API. Moreover, with read-write map API, you can make
 CAS­like comparisons not only based on value equality but based on
 metadata parameter equality such as version information, and you can
 send back previous value or boolean instances to signal whether the
 CAS­like comparison succeeded.</p>
</div>
<div class="paragraph">
<p>Implementing a write operation that returns the previous value associated
 with the cache entry is easy to achieve with the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.commons.api.functional.EntryView.*;
import org.infinispan.commons.api.functional.FunctionalMap.*;

ReadWriteMap&lt;String, String&gt; readWriteMap = ...

CompletableFuture&lt;Optional&lt;String&gt;&gt; readWriteFuture = readWriteMap.eval("key1", "value1", (v, view) -&gt; {
   Optional&lt;V&gt; prev = rw.find();
   view.set(v);
   return prev;
});
readWriteFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>ConcurrentMap.replace(K, V, V) is a replace function that compares the
 value present in the map and if it&#8217;s equals to the value passed in as
 first parameter, the second value is stored, returning a boolean
 indicating whether the replace was successfully completed. This operation
 can easily be implemented using the read-write map API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ReadWriteMap&lt;String, String&gt; readWriteMap = ...

String oldValue = "old-value";
CompletableFuture&lt;Boolean&gt; replaceFuture = readWriteMap.eval("key1", "value1", (v, view) -&gt; {
   return view.find().map(prev -&gt; {
      if (prev.equals(oldValue)) {
         rw.set(v);
         return true; // previous value present and equals to the expected one
      }
      return false; // previous value associated with key does not match
   }).orElse(false); // no value associated with this key
});
replaceFuture.thenAccept(replaced -&gt; System.out.printf("Value was replaced? %s%n", replaced));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The lambda in the example above captures <code>oldValue</code> which is an
 external value to the lambda which is valid use case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Read-write map API contains <code>evalMany</code> and <code>evalAll</code> operations which behave
 similar to the write-only map offerings, except that they enable previous
 value and metadata parameters to be read.</p>
</div>
<div class="sect4">
<h5 id="_read_write_entry_view">Read-Write Entry View</h5>
<div class="paragraph">
<p>The lambda parameters for read-write maps provide the user with the
 possibility to query the information associated with the key, including
 value and metadata parameters, and the user can also use this view to
 modify the data in the cache.</p>
</div>
<div class="paragraph">
<p>The operations are exposed by read-write entry views are a union of
 the operations exposed by <a href="#_read-only_entry_view">read_only entry views</a>
 and <a href="#_write_only_entry_view">write-only entry views</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_meta_parameter">Metadata Parameter Handling</h4>
<div class="paragraph">
<p>Metadata parameters provide extra information about the cache entry, such
 as version information, lifespan, last accessed/used time&#8230;&#8203;etc. Some of
 these can be provided by the user, e.g. version, lifespan&#8230;&#8203;etc, but some
 others are computed internally and can only be queried, e.g. last
 accessed/used time.</p>
</div>
<div class="paragraph">
<p>The functional map API provides a flexible way to store metadata parameters
 along with an cache entry. To be able to store a metadata parameter, it must
 extend MetaParam.Writable interface, and implement the methods to allow the
 internal logic to extra the data. Storing is done via the
 set(V, MetaParam.Writable&#8230;&#8203;) method in
 <a href="#_write_only_entry_view">write-only entry view</a> or
 <a href="#_read_write_entry_view">read-write entry view</a> lambda parameters.</p>
</div>
<div class="paragraph">
<p>Querying metadata parameters is available via the findMetaParam(Class) method
 available via <a href="#_read_write_entry_view">read-write entry view</a> or
 <a href="#_read_only_entry_view">read-only entry view</a> or lambda parameters.</p>
</div>
<div class="paragraph">
<p>Here is an example showing how to store metadata parameters and how to query
 them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.commons.api.functional.EntryView.*;
import org.infinispan.commons.api.functional.FunctionalMap.*;
import org.infinispan.commons.api.functional.MetaParam.*;

WriteOnlyMap&lt;String, String&gt; writeOnlyMap = ...
ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;Void&gt; writeFuture = writeOnlyMap.eval("key1", "value1",
   (v, view) -&gt; view.set(v, new MetaLifespan(Duration.ofHours(1).toMillis())));
CompletableFuture&lt;MetaLifespan&gt; readFuture = writeFuture.thenCompose(r -&gt;
   readOnlyMap.eval("key1", view -&gt; view.findMetaParam(MetaLifespan.class).get()));
readFuture.thenAccept(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the metadata parameter is generic, for example MetaEntryVersion&lt;T&gt;,
 retrieving the metadata parameter along with a specific type can be tricky
 if using <code>.class</code> static helper in a class because it does not return a
 Class&lt;T&gt; but only Class, and hence any generic information in the class is
 lost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;String&gt; readFuture = readOnlyMap.eval("key1", view -&gt; {
   // If caller depends on the typed information, this is not an ideal way to retrieve it
   // If the caller does not depend on the specific type, this works just fine.
   Optional&lt;MetaEntryVersion&gt; version = view.findMetaParam(MetaLifespan.class);
   return view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>When generic information is important the user can define a static helper
 method that coerces the static class retrieval to the type requested,
 and then use that helper method in the call to findMetaParam:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class MetaEntryVersion&lt;T&gt; implements MetaParam.Writable&lt;EntryVersion&lt;T&gt;&gt; {
   ...
   public static &lt;T&gt; T type() { return (T) MetaEntryVersion.class; }
   ...
}

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...

CompletableFuture&lt;String&gt; readFuture = readOnlyMap.eval("key1", view -&gt; {
   // The caller wants guarantees that the metadata parameter for version is numeric
   // e.g. to query the actual version information
   Optional&lt;MetaEntryVersion&lt;Long&gt;&gt; version = view.findMetaParam(MetaLifespan.type());
   return view.get();
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, users are free to create new instances of metadata parameters to
 suit their needs. They are stored and retrieved in the very same way as done
 for the metadata parameters already provided by the functional map API.</p>
</div>
</div>
<div class="sect3">
<h4 id="_invocation_parameter">Invocation Parameter</h4>
<div class="paragraph">
<p>Per-invocation parameters are applied to regular functional map API calls to
 alter the behaviour of certain aspects. Adding per invocation parameters is
 done using the withParams(Param&lt;?&gt;&#8230;&#8203;) method.</p>
</div>
<div class="paragraph">
<p>Param.FutureMode tweaks whether a method returning a CompletableFuture will
 span a thread to invoke the method, or instead will use the caller thread.
 By default, whenever a call is made to a method returning a
 CompletableFuture, a separate thread will be span to execute the method
 asynchronously. However, if the caller will immediately block waiting for
 the CompletableFuture to complete, spanning a different thread is wasteful,
 and hence Param.FutureMode.COMPLETED can be passed as per-invocation
 parameter to avoid creating that extra thread. Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.infinispan.commons.api.functional.EntryView.*;
import org.infinispan.commons.api.functional.FunctionalMap.*;
import org.infinispan.commons.api.functional.Param.*;

ReadOnlyMap&lt;String, String&gt; readOnlyMap = ...
ReadOnlyMap&lt;String, String&gt; readOnlyMapCompleted = readOnlyMap.withParams(FutureMode.COMPLETED);
Optional&lt;String&gt; readFuture = readOnlyMapCompleted.eval("key1", ReadEntryView::find).get();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functional_listeners">Functional Listeners</h4>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="_marshalling_of_lambdas">Marshalling of Lambdas</h4>
<div class="paragraph">
<p>&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_cases_for_functional_api">Use cases for Functional API</h4>
<div class="paragraph">
<p>This new API is meant to complement existing Key/Value Infinispan API
offerings, so you&#8217;ll still be able to use ConcurrentMap or JCache
standard APIs if that&#8217;s what suits your use case best.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-08-28 10:04:42 CEST
</div>
</div>
</body>
</html>